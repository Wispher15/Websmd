<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Lapi - SP Apoteker v3</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <style>
        :root {
            --primary-color: #0070c9;
            --bg-color: #f5f7fa;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            margin: 20px;
        }

        .container {
            max-width: 1000px;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: auto;
        }

        h1 { text-align: center; color: var(--primary-color); }

        .customer-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f0f4f8;
            border-radius: 8px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .product-row {
            display: grid;
            grid-template-columns: 3fr 1.2fr 0.5fr;
            gap: 10px;
            margin-bottom: 12px;
            align-items: center;
        }

        .qty-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
            font-size: 16px;
            text-align: center;
        }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { opacity: 1; height: 30px; }

        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-add { background: #28a745; color: white; margin-bottom: 15px; }
        .btn-calc { background: var(--primary-color); color: white; width: 100%; margin-top: 10px; }
        .btn-del { background: #d9534f; color: white; }
        .btn-reset { background: #6c757d; color: white; flex: 1; }
        .btn-pdf { background: #17a2b8; color: white; flex: 1; }

        .action-buttons { display: flex; gap: 10px; margin-top: 20px; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th { background: #eeeeee; color: #333; padding: 12px; border: 1px solid #ddd; text-align: left; }
        td { border: 1px solid #ddd; padding: 10px; }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
            padding: 20px;
            background: #fff;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
        }

        .summary-item { display: flex; justify-content: space-between; font-weight: bold; border-bottom: 1px solid #eee; padding: 6px 0; font-size: 0.9em; }

        .grand-total-box { grid-column: 1 / -1; text-align: right; padding-top: 15px; }

        #printHeader { display: none; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
        #printSignature { display: none; margin-top: 50px; text-align: right; }

        @media print {
            @page { margin: 1cm; }
            body { background: white; margin: 0; padding: 0; }
            .container { box-shadow: none; border: none; max-width: 100%; }
            h1, .btn, .btn-add, .btn-calc, .btn-del, .product-row, .customer-section, 
            label, #hargaType, #discountInput, .action-buttons, #typeSummary, .cn-box {
                display: none !important;
            }
            table th:nth-child(1), table td:nth-child(1) { display: none; }
            .summary-grid { border: none; padding: 0; display: block; }
            .grand-total-box { text-align: right; border-top: 1px solid #000; margin-top: 20px; }
            #printHeader, #printSignature { display: block; }
        }
    </style>
</head>
<body>

<div class="container">
    <div id="printHeader">
        <div style="display: flex; justify-content: space-between;">
            <div>
                <h2 id="displayCustomerName" style="margin:0;">SP: -</h2>
                <p id="displayDistributor" style="margin:5px 0; font-weight:bold;"></p>
            </div>
            <div style="text-align: right;">
                <p id="displayNota" style="margin:0; font-weight:bold;"></p>
                <p id="displayDate" style="margin:5px 0; color:#666;"></p>
            </div>
        </div>
    </div>

    <h1>Kalkulator Lapi</h1>
    
    <div class="customer-section">
        <div>
            <label>Nama Customer:</label>
            <input type="text" id="customerName" placeholder="Nama Apotek/Klinik..." style="width:100%; padding:10px; border-radius:6px; border:1px solid #ddd; box-sizing: border-box;">
        </div>
        <div>
            <label>Pilih Distributor:</label>
            <select id="distributorSelect" style="width:100%; padding:10px; border-radius:6px; border:1px solid #ddd;">
                <option value="MPI">MPI</option>
                <option value="Kalista">Kalista</option>
                <option value="Penta Valent">Penta Valent</option>
            </select>
        </div>
    </div>

    <div id="productsContainer"></div>
    <button class="btn btn-add" onclick="addProductRow()">+ Tambah Produk</button>
    
    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <div style="flex: 1;">
            <label>Jenis Harga:</label>
            <select id="hargaType" style="padding: 10px; width: 100%; border-radius: 6px;">
                <option value="hna">HNA (Box)</option>
                <option value="harga_tab">Harga per Tab</option>
            </select>
        </div>
        <div style="flex: 1;">
            <label>Diskon (%):</label>
            <input type="number" id="discountInput" value="0" min="0" max="100" style="padding: 10px; width: 100%; border-radius: 6px; box-sizing: border-box;">
        </div>
    </div>

    <button class="btn btn-calc" onclick="calculate(true)">Hitung Rincian</button>
    
    <div id="resultsArea" style="display:none;">
        <table>
            <thead>
                <tr>
                    <th>Type - Divisi</th>
                    <th>Nama Produk</th>
                    <th>Qty</th>
                    <th>HNA Satuan</th>
                    <th>Total HNA</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>

        <div class="summary-grid">
            <div id="typeSummary">
                <div class="summary-item"><span>Oral:</span> <span id="sumOral">0</span></div>
                <div class="summary-item"><span>Injeksi:</span> <span id="sumInjeksi">0</span></div>
                <div class="summary-item"><span>Generik:</span> <span id="sumGenerik">0</span></div>
                <div class="summary-item" style="color: var(--primary-color);"><span>BRANDED (O+I):</span> <span id="sumBranded">0</span></div>
                <div class="summary-item"><span>FARMA (Pure):</span> <span id="sumFarmaPure">0</span></div>
                <div class="summary-item"><span>MEDIKA:</span> <span id="sumMedika">0</span></div>
                <div class="summary-item" style="border-top: 1px solid #ddd;"><span>DIVISI FARMED (F+M):</span> <span id="sumFarmed">0</span></div>
                <div class="summary-item cn-box" style="background: #fff3cd; padding: 5px; margin-top: 10px; border: 1px dashed #856404;">
                    <span>CN (HNA x Disc):</span> <span id="sumCN">0</span>
                </div>
            </div>

            <div class="grand-total-box">
                <div style="font-weight: bold; font-size: 1.2em">TOTAL HNA: <span id="grandTotalHna">Rp 0</span></div>
                <div style="color: #555;">+PPN 11%: <span id="totalPpn">Rp 0</span></div>
                <div style="font-size: 1.4em; color: var(--primary-color); font-weight: 800; border-top: 2px solid #ddd; padding-top: 5px;">
                    TOTAL NET: <span id="totalNet">Rp 0</span>
                </div>
            </div>
        </div>

        <div id="printSignature">
            <p style="margin-bottom: 70px;">Apoteker Penanggung Jawab,</p>
            <p>( __________________________ )</p>
            <p style="margin-top: 5px;">SIPA No. : ___________________</p>
        </div>
        
        <div class="action-buttons">
            <button class="btn btn-pdf" onclick="preparePrint()">Simpan sebagai SP PDF</button>
            <button class="btn btn-reset" onclick="resetAll()">Reset</button>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<script>
    let productDatabase = [];

    function cleanNumber(str) {
        if (!str) return 0;
        let clean = str.replace(/\./g, '').replace(',', '.');
        return parseFloat(clean) || 0;
    }

    function generateNota() {
        const now = new Date();
        return `SP-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
    }

    function loadData() {
        const url = "https://raw.githubusercontent.com/Wispher15/Websmd/refs/heads/main/Harganov25.csv";
        fetch(url).then(res => res.text()).then(data => {
            const lines = data.split("\n").slice(1);
            lines.forEach(line => {
                const cols = line.split(",");
                if (cols.length >= 7) {
                    productDatabase.push({
                        kode: cols[0].trim(), nama: cols[1].trim(), hna: cleanNumber(cols[2]),
                        isi: cols[3].trim(), harga_tab: cleanNumber(cols[4]),
                        divisi: cols[5].trim().toUpperCase(), type: cols[6].trim().toUpperCase()
                    });
                }
            });
            loadHistory();
        });
    }

    function addProductRow(savedName = "", savedQty = 1) {
        const id = Date.now() + Math.random();
        const html = `<div class="product-row" id="row-${id}">
            <select class="product-select"><option value="">Cari Produk...</option>
            ${productDatabase.map(p => `<option value="${p.nama}" ${p.nama === savedName ? 'selected' : ''}>${p.nama}</option>`).join('')}
            </select><input type="number" class="qty-input" value="${savedQty}" min="1">
            <button class="btn btn-del" onclick="removeRow(${id})">X</button></div>`;
        $('#productsContainer').append(html);
        $('.product-select').last().select2();
    }

    function removeRow(id) { $(`#row-${id}`).remove(); }
    function formatIDR(num) { return "Rp " + Math.round(num).toLocaleString('id-ID'); }

    function calculate(isManual) {
        let totals = { oral: 0, injeksi: 0, generik: 0, farma: 0, medika: 0, farmaPure: 0, grandHna: 0 };
        const hargaType = $('#hargaType').val();
        const discPerc = parseFloat($('#discountInput').val()) || 0;
        let tableHtml = '';

        $('.product-row').each(function() {
            const name = $(this).find('.product-select').val();
            const qty = parseFloat($(this).find('.qty-input').val()) || 0;
            const p = productDatabase.find(i => i.nama === name);

            if (p && qty > 0) {
                const price = (hargaType === 'hna') ? p.hna : p.harga_tab;
                const lineHna = price * qty;
                tableHtml += `<tr><td>${p.type} - ${p.divisi}</td><td>${p.nama}</td><td>${qty}</td><td>${formatIDR(price)}</td><td>${formatIDR(lineHna)}</td></tr>`;
                
                // Kategori Dasar
                if (p.type.includes('ORAL')) totals.oral += lineHna;
                if (p.type.includes('INJEKSI')) totals.injeksi += lineHna;
                if (p.type.includes('GENERIK')) totals.generik += lineHna;
                
                // Logika Divisi
                if (p.divisi === 'FARMA') {
                    totals.farma += lineHna;
                    // Farma Pure (Farma yang bukan Generik)
                    if (!p.type.includes('GENERIK')) totals.farmaPure += lineHna;
                }
                if (p.divisi === 'MEDIKA') totals.medika += lineHna;
                
                totals.grandHna += lineHna;
            }
        });

        const totalPpnVal = totals.grandHna * 1.11;
        const totalNetVal = totalPpnVal * (1 - (discPerc / 100));
        const valCN = totals.grandHna * (discPerc / 100);

        $('#tableBody').html(tableHtml);
        $('#sumOral').text(formatIDR(totals.oral));
        $('#sumInjeksi').text(formatIDR(totals.injeksi));
        $('#sumGenerik').text(formatIDR(totals.generik));
        $('#sumBranded').text(formatIDR(totals.oral + totals.injeksi));
        $('#sumFarmaPure').text(formatIDR(totals.farmaPure));
        $('#sumMedika').text(formatIDR(totals.medika));
        $('#sumFarmed').text(formatIDR(totals.farma + totals.medika));
        $('#sumCN').text(formatIDR(valCN));
        $('#grandTotalHna').text(formatIDR(totals.grandHna));
        $('#totalPpn').text(formatIDR(totalPpnVal));
        $('#totalNet').text(formatIDR(totalNetVal));
        
        if (tableHtml !== "") { $('#resultsArea').show(); if (isManual) saveHistory(); }
    }

    function saveHistory() {
        let history = [];
        $('.product-row').each(function() {
            const name = $(this).find('.product-select').val();
            const qty = $(this).find('.qty-input').val();
            if (name) history.push({ name, qty });
        });
        localStorage.setItem('lapi_history', JSON.stringify(history));
        localStorage.setItem('lapi_cust', $('#customerName').val());
        localStorage.setItem('lapi_dist', $('#distributorSelect').val());
        localStorage.setItem('lapi_disc', $('#discountInput').val());
    }

    function loadHistory() {
        $('#customerName').val(localStorage.getItem('lapi_cust') || "");
        $('#distributorSelect').val(localStorage.getItem('lapi_dist') || "MPI");
        $('#discountInput').val(localStorage.getItem('lapi_disc') || "0");
        const saved = localStorage.getItem('lapi_history');
        if (saved) { JSON.parse(saved).forEach(item => addProductRow(item.name, item.qty)); calculate(false); } 
        else { addProductRow(); }
    }

    function preparePrint() {
        $('#displayCustomerName').text("SP: " + ($('#customerName').val() || "UMUM").toUpperCase());
        $('#displayDistributor').text("DISTRIBUTOR: " + $('#distributorSelect').val().toUpperCase());
        $('#displayNota').text("NO: " + generateNota());
        $('#displayDate').text("Tanggal: " + new Date().toLocaleDateString('id-ID'));
        window.print();
    }

    function resetAll() { if (confirm("Hapus semua?")) { localStorage.clear(); location.reload(); } }

    $(document).ready(loadData);
</script>
</body>
</html>
