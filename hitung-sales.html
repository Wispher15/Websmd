<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Lapi - SP Pro Manual Search</title>
    <style>
        :root { --primary-color: #0070c9; --bg-color: #f5f7fa; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); margin: 10px; }
        .container { max-width: 1000px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin: auto; }
        h1 { text-align: center; color: var(--primary-color); font-size: 1.5em; }

        .customer-section { margin-bottom: 15px; padding: 12px; background: #f0f4f8; border-radius: 8px; display: grid; grid-template-columns: 1fr; gap: 10px; }
        
        /* Layout Baris Produk */
        .product-row { display: grid; grid-template-columns: 1fr 70px 40px; gap: 8px; margin-bottom: 10px; align-items: center; }
        
        .input-style { padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box; width: 100%; }
        .qty-input { text-align: center; padding: 12px 0; }

        .btn { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-add { background: #28a745; color: white; width: 100%; margin-bottom: 15px; }
        .btn-calc { background: var(--primary-color); color: white; width: 100%; }
        .btn-del { background: #d9534f; color: white; font-size: 18px; }
        
        .action-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .btn-pdf { background: #17a2b8; color: white; }
        .btn-reset { background: #6c757d; color: white; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #eee; }

        .summary-grid { margin-top: 15px; padding: 15px; border: 2px solid var(--primary-color); border-radius: 8px; }
        .summary-item { display: flex; justify-content: space-between; font-weight: bold; border-bottom: 1px solid #eee; padding: 6px 0; }
        .grand-total-box { text-align: right; margin-top: 10px; }

        #printHeader, #printSignature { display: none; }

        @media print {
            body { margin: 0; }
            .container { box-shadow: none; border: none; }
            h1, .btn, .btn-add, .btn-calc, .btn-del, .product-row, .customer-section, label, #hargaType, #discountInput, .action-buttons, #typeSummary, .cn-box { display: none !important; }
            table th:nth-child(1), table td:nth-child(1) { display: none; }
            #printHeader, #printSignature { display: block; }
        }
    </style>
</head>
<body>

<div class="container">
    <div id="printHeader">
        <h2 id="displayCustomerName" style="margin:0;">SP: -</h2>
        <p id="displayDistributor" style="margin:5px 0; font-weight:bold;"></p>
        <p id="displayNota" style="margin:0; font-weight:bold;"></p>
        <p id="displayDate" style="margin:5px 0; color:#666;"></p>
    </div>

    <h1>Kalkulator Lapi</h1>
    
    <div class="customer-section">
        <input type="text" id="customerName" class="input-style" placeholder="Nama Customer...">
        <select id="distributorSelect" class="input-style">
            <option value="MPI">Distributor: MPI</option>
            <option value="Kalista">Distributor: Kalista</option>
            <option value="Penta Valent">Distributor: Penta Valent</option>
        </select>
    </div>

    <div id="productsContainer"></div>
    <button class="btn btn-add" onclick="addProductRow()">+ Tambah Produk</button>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
        <select id="hargaType" class="input-style">
            <option value="hna">HNA (Box)</option>
            <option value="harga_tab">Harga/Tab</option>
        </select>
        <input type="number" id="discountInput" class="input-style" placeholder="Disc %" value="0">
    </div>

    <button class="btn btn-calc" onclick="calculate(true)">Hitung Rincian</button>
    
    <datalist id="productList"></datalist>

    <div id="resultsArea" style="display:none;">
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr><th>Type</th><th>Produk</th><th>Qty</th><th>Harga</th><th>Total</th></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div class="summary-grid">
            <div id="typeSummary">
                <div class="summary-item"><span>Oral:</span> <span id="sumOral">0</span></div>
                <div class="summary-item"><span>Injeksi:</span> <span id="sumInjeksi">0</span></div>
                <div class="summary-item"><span>Generik:</span> <span id="sumGenerik">0</span></div>
                <div class="summary-item"><span>Farma (Pure):</span> <span id="sumFarmaPure">0</span></div>
                <div class="summary-item"><span>Medika:</span> <span id="sumMedika">0</span></div>
                <div class="summary-item" style="color:var(--primary-color)"><span>Farmed (F+M):</span> <span id="sumFarmed">0</span></div>
                <div class="summary-item cn-box" style="background:#fff3cd; padding:5px; border:1px dashed #856404;">
                    <span>CN (HNA x Disc):</span> <span id="sumCN">0</span>
                </div>
            </div>

            <div class="grand-total-box">
                <div style="font-weight:bold;">TOTAL HNA: <span id="grandTotalHna">Rp 0</span></div>
                <div style="font-size: 0.9em; color:#666;">+PPN 11%: <span id="totalPpn">Rp 0</span></div>
                <div style="font-size: 1.3em; color:var(--primary-color); font-weight:800;">NET: <span id="totalNet">0</span></div>
            </div>
        </div>

        <div id="printSignature" style="margin-top:40px; text-align:right;">
            <p>Apoteker Penanggung Jawab,</p>
            <br><br><br>
            <p>( __________________________ )</p>
            <p>SIPA No. : ___________________</p>
        </div>
        
        <div class="action-buttons">
            <button class="btn btn-pdf" onclick="preparePrint()">Simpan sebagai SP PDF</button>
            <button class="btn btn-reset" onclick="resetAll()">Reset</button>
        </div>
    </div>
</div>

<script>
    let productDatabase = [];

    function cleanNumber(str) {
        if (!str) return 0;
        let clean = str.replace(/\./g, '').replace(',', '.');
        return parseFloat(clean) || 0;
    }

    function generateNota() {
        const now = new Date();
        return `SP-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
    }

    function loadData() {
        const url = "https://raw.githubusercontent.com/Wispher15/Websmd/refs/heads/main/Harganov25.csv";
        fetch(url).then(res => res.text()).then(data => {
            const lines = data.split("\n").slice(1);
            let options = "";
            lines.forEach(line => {
                const cols = line.split(",");
                if (cols.length >= 7) {
                    const prod = {
                        kode: cols[0].trim(), nama: cols[1].trim(), hna: cleanNumber(cols[2]),
                        divisi: cols[5].trim().toUpperCase(), type: cols[6].trim().toUpperCase(), harga_tab: cleanNumber(cols[4])
                    };
                    productDatabase.push(prod);
                    options += `<option value="${prod.nama} (${prod.kode})">`;
                }
            });
            document.getElementById('productList').innerHTML = options;
            loadHistory();
        });
    }

    function addProductRow(savedValue = "", savedQty = 1) {
        const id = Date.now() + Math.random();
        const html = `
            <div class="product-row" id="row-${id}">
                <input type="text" list="productList" class="input-style prod-input" value="${savedValue}" placeholder="Ketik Nama/ID...">
                <input type="number" class="input-style qty-input" value="${savedQty}" min="1">
                <button class="btn btn-del" onclick="removeRow(${id})">Ã—</button>
            </div>`;
        document.getElementById('productsContainer').insertAdjacentHTML('beforeend', html);
    }

    function removeRow(id) { document.getElementById(`row-${id}`).remove(); }
    function formatIDR(num) { return "Rp " + Math.round(num).toLocaleString('id-ID'); }

    function calculate(isManual) {
        let totals = { oral: 0, injeksi: 0, generik: 0, farma: 0, medika: 0, farmaPure: 0, grandHna: 0 };
        const hargaType = document.getElementById('hargaType').value;
        const discPerc = parseFloat(document.getElementById('discountInput').value) || 0;
        let tableHtml = '';

        document.querySelectorAll('.product-row').each = Array.prototype.forEach;
        document.querySelectorAll('.product-row').forEach(row => {
            const val = row.querySelector('.prod-input').value;
            const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
            
            // Cari produk berdasarkan string "Nama (ID)"
            const p = productDatabase.find(i => `${i.nama} (${i.kode})` === val || i.nama === val);

            if (p && qty > 0) {
                const price = (hargaType === 'hna') ? p.hna : p.harga_tab;
                const lineHna = price * qty;
                tableHtml += `<tr><td>${p.type}</td><td>${p.nama}</td><td>${qty}</td><td>${formatIDR(price)}</td><td>${formatIDR(lineHna)}</td></tr>`;
                
                if (p.type.includes('ORAL')) totals.oral += lineHna;
                if (p.type.includes('INJEKSI')) totals.injeksi += lineHna;
                if (p.type.includes('GENERIK')) totals.generik += lineHna;
                if (p.divisi === 'FARMA') {
                    totals.farma += lineHna;
                    if (!p.type.includes('GENERIK')) totals.farmaPure += lineHna;
                }
                if (p.divisi === 'MEDIKA') totals.medika += lineHna;
                totals.grandHna += lineHna;
            }
        });

        const totalPpnVal = totals.grandHna * 1.11;
        const totalNetVal = totalPpnVal * (1 - (discPerc / 100));
        const valCN = totals.grandHna * (discPerc / 100);

        document.getElementById('tableBody').innerHTML = tableHtml;
        document.getElementById('sumOral').innerText = formatIDR(totals.oral);
        document.getElementById('sumInjeksi').innerText = formatIDR(totals.injeksi);
        document.getElementById('sumGenerik').innerText = formatIDR(totals.generik);
        document.getElementById('sumFarmaPure').innerText = formatIDR(totals.farmaPure);
        document.getElementById('sumMedika').innerText = formatIDR(totals.medika);
        document.getElementById('sumFarmed').innerText = formatIDR(totals.farma + totals.medika);
        document.getElementById('sumCN').innerText = formatIDR(valCN);
        document.getElementById('grandTotalHna').innerText = formatIDR(totals.grandHna);
        document.getElementById('totalPpn').innerText = formatIDR(totalPpnVal);
        document.getElementById('totalNet').innerText = formatIDR(totalNetVal);
        
        if (tableHtml !== "") {
            document.getElementById('resultsArea').style.display = 'block';
            if (isManual) saveHistory();
        }
    }

    function saveHistory() {
        let history = [];
        document.querySelectorAll('.product-row').forEach(row => {
            history.push({ v: row.querySelector('.prod-input').value, q: row.querySelector('.qty-input').value });
        });
        localStorage.setItem('lapi_hist_v4', JSON.stringify(history));
        localStorage.setItem('lapi_cust', document.getElementById('customerName').value);
        localStorage.setItem('lapi_dist', document.getElementById('distributorSelect').value);
    }

    function loadHistory() {
        document.getElementById('customerName').value = localStorage.getItem('lapi_cust') || "";
        document.getElementById('distributorSelect').value = localStorage.getItem('lapi_dist') || "MPI";
        const saved = localStorage.getItem('lapi_hist_v4');
        if (saved) { JSON.parse(saved).forEach(item => addProductRow(item.v, item.q)); calculate(false); } 
        else { addProductRow(); }
    }

    function preparePrint() {
        document.getElementById('displayCustomerName').innerText = "SP: " + (document.getElementById('customerName').value || "UMUM").toUpperCase();
        document.getElementById('displayDistributor').innerText = "DISTRIBUTOR: " + document.getElementById('distributorSelect').value;
        document.getElementById('displayNota').innerText = "NO: " + generateNota();
        document.getElementById('displayDate').innerText = "Tanggal: " + new Date().toLocaleDateString('id-ID');
        window.print();
    }

    function resetAll() { if (confirm("Hapus semua?")) { localStorage.clear(); location.reload(); } }

    window.onload = loadData;
</script>
</body>
</html>
