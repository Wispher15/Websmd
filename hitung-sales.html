<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hitung Sales - Web SMD 2026</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">ONLINE SYSTEM</div>
        <ul class="menu-list">
            <li><a href="index.html" class="menu-item">Dashboard</a></li>
            <li class="menu-item-wrapper">
                <a href="#" class="menu-item">Evaluasi Sales <span>›</span></a>
                <ul class="submenu">
                    <li><a href="sales-harian.html" class="submenu-item">Sales Harian</a></li>
                    <li><a href="perbandingan-bin.html" class="submenu-item">Perbandingan 2 Bin</a></li>
                    <li><a href="trend-sales.html" class="submenu-item">Trend Sales Unit</a></li>
                </ul>
            </li>
            <li><a href="stok-distributor.html" class="menu-item">Stok Distributor</a></li>
            <li><a href="hitung-sales.html" class="menu-item active">Hitung Sales</a></li>
            <li><a href="cuti.html" class="menu-item" style="color: #ef4444; font-weight: 700;">Cuti-Cuti !!!</a></li>
        </ul>
    </div>

    <div class="main-content">
        <header>
            <span>Kalkulator Lapi - Sales Pro</span>
            <div id="printHeader" style="display: none;">
                <h2 id="displayCustomerName">SP: -</h2>
                <p id="displayNota"></p>
            </div>
        </header>
        
        <div class="content-area">
            <div class="card" style="margin-bottom: 20px;">
                <div class="customer-section-modern">
                    <div class="input-group">
                        <label>Nama Customer</label>
                        <input type="text" id="customerName" class="url-bar" placeholder="Nama Apotek/Klinik...">
                    </div>
                    <div class="input-group">
                        <label>Distributor</label>
                        <select id="distributorSelect" class="url-bar">
                            <option value="MPI">MPI</option>
                            <option value="Kalista">Kalista</option>
                            <option value="Penta Valent">Penta Valent</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px; font-size: 1rem;">Input Pesanan</h3>
                <div id="productsContainer"></div>
                <button class="btn-add-modern" onclick="addProductRow()">+ Tambah Baris Produk</button>
                
                <div class="calc-settings">
                    <div class="input-group">
                        <label>Jenis Harga</label>
                        <select id="hargaType" class="url-bar">
                            <option value="hna">HNA (Box)</option>
                            <option value="harga_tab">Harga per Tab</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Diskon (%)</label>
                        <input type="number" id="discountInput" class="url-bar" value="0">
                    </div>
                </div>
                <button class="btn-go" style="width: 100%; margin-top: 15px;" onclick="calculate(true)">Hitung Rincian</button>
            </div>

            <div id="resultsArea" style="display:none;">
                <div class="card">
                    <div style="overflow-x: auto;">
                        <table class="modern-table border-vertical">
                            <thead>
                                <tr>
                                    <th>Type - Divisi</th>
                                    <th>Produk</th>
                                    <th>Qty</th>
                                    <th>Harga Satuan</th>
                                    <th>Total HNA</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>

                    <div class="summary-grid-modern">
                        <div id="typeSummary">
                            <div class="sum-line">Oral: <span id="sumOral">0</span></div>
                            <div class="sum-line">Injeksi: <span id="sumInjeksi">0</span></div>
                            <div class="sum-line highlight">BRANDED (O+I): <span id="sumBranded">0</span></div>
                            <div class="sum-line">Generik: <span id="sumGenerik">0</span></div>
                            <div class="sum-line">FARMA (Pure): <span id="sumFarmaPure">0</span></div>
                            <div class="sum-line">MEDIKA: <span id="sumMedika">0</span></div>
                            <div class="sum-line" style="border-top: 1px solid #ddd; padding-top: 5px; margin-top: 5px;">DIVISI FARMED: <span id="sumFarmed">0</span></div>
                            <div class="sum-line cn-box" style="background: #fff3cd; padding: 5px; border-radius: 4px;">CN (Disc): <span id="sumCN">0</span></div>
                        </div>

                        <div class="grand-total-modern">
                            <div class="total-label" style="font-size: 1rem; color: #64748b;">TOTAL HNA: <span id="grandTotalHna">0</span></div>
                            <div class="ppn-label" style="font-size: 0.9rem; color: #94a3b8;">+PPN 11%: <span id="totalPpn">0</span></div>
                            <div class="net-label" style="font-size: 1.6rem; color: #10b981; font-weight: 800;">NET: <span id="totalNet">0</span></div>
                        </div>
                    </div>

                    <div class="action-buttons-modern">
                        <button class="btn-go" style="background: #3b82f6; flex: 1;" onclick="preparePrint()">Simpan PDF</button>
                        <button class="btn-go" style="background: #64748b; flex: 1;" onclick="resetAll()">Reset</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <datalist id="productList"></datalist>

    <script>
        let productDatabase = [];

        function cleanNumber(str) {
            if (!str) return 0;
            let clean = str.replace(/\./g, '').replace(',', '.');
            return parseFloat(clean) || 0;
        }

        function formatNumber(num) {
            return Math.round(num).toLocaleString('id-ID');
        }

        function loadData() {
            const url = "https://raw.githubusercontent.com/Wispher15/Websmd/refs/heads/main/Harganov25.csv";
            fetch(url).then(res => res.text()).then(data => {
                const lines = data.split("\n").slice(1);
                let options = "";
                lines.forEach(line => {
                    const cols = line.split(",");
                    if (cols.length >= 7) {
                        const prod = {
                            kode: cols[0].trim(), 
                            nama: cols[1].trim(), 
                            hna: cleanNumber(cols[2]),
                            divisi: cols[5].trim().toUpperCase(), 
                            type: cols[6].trim().toUpperCase(), 
                            harga_tab: cleanNumber(cols[4])
                        };
                        productDatabase.push(prod);
                        options += `<option value="${prod.nama} (${prod.kode})">`;
                    }
                });
                document.getElementById('productList').innerHTML = options;
                loadHistory();
            });
        }

        function addProductRow(savedVal = "", savedQty = 1) {
            const id = Date.now() + Math.random();
            const html = `
                <div class="product-row-modern" id="row-${id}">
                    <input type="text" list="productList" class="url-bar prod-input" value="${savedVal}" placeholder="Cari Produk...">
                    <input type="number" class="url-bar qty-input" value="${savedQty}" style="width: 80px; text-align: center;">
                    <button class="btn-del-mini" onclick="removeRow(${id})">✕</button>
                </div>`;
            document.getElementById('productsContainer').insertAdjacentHTML('beforeend', html);
        }

        function removeRow(id) { document.getElementById(`row-${id}`).remove(); }

        function calculate(isManual) {
            let totals = { oral: 0, injeksi: 0, generik: 0, farma: 0, medika: 0, farmaPure: 0, grandHna: 0 };
            const hargaType = document.getElementById('hargaType').value;
            const discPerc = parseFloat(document.getElementById('discountInput').value) || 0;
            let tableHtml = '';

            document.querySelectorAll('.product-row-modern').forEach(row => {
                const val = row.querySelector('.prod-input').value;
                const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
                const p = productDatabase.find(i => `${i.nama} (${i.kode})` === val || i.nama === val);

                if (p && qty > 0) {
                    const price = (hargaType === 'hna') ? p.hna : p.harga_tab;
                    const lineHna = price * qty;
                    tableHtml += `<tr><td>${p.type} - ${p.divisi}</td><td>${p.nama}</td><td>${qty}</td><td>${formatNumber(price)}</td><td>${formatNumber(lineHna)}</td></tr>`;
                    
                    if (p.type.includes('ORAL')) totals.oral += lineHna;
                    if (p.type.includes('INJEKSI')) totals.injeksi += lineHna;
                    if (p.type.includes('GENERIK')) totals.generik += lineHna;
                    
                    if (p.divisi === 'FARMA') {
                        totals.farma += lineHna;
                        if (!p.type.includes('GENERIK')) totals.farmaPure += lineHna;
                    }
                    if (p.divisi === 'MEDIKA') totals.medika += lineHna;
                    
                    totals.grandHna += lineHna;
                }
            });

            const totalPpnVal = totals.grandHna * 1.11;
            const totalNetVal = totalPpnVal * (1 - (discPerc / 100));
            const valCN = totals.grandHna * (discPerc / 100);

            document.getElementById('tableBody').innerHTML = tableHtml;
            document.getElementById('sumOral').innerText = formatNumber(totals.oral);
            document.getElementById('sumInjeksi').innerText = formatNumber(totals.injeksi);
            document.getElementById('sumBranded').innerText = formatNumber(totals.oral + totals.injeksi);
            document.getElementById('sumGenerik').innerText = formatNumber(totals.generik);
            document.getElementById('sumFarmaPure').innerText = formatNumber(totals.farmaPure);
            document.getElementById('sumMedika').innerText = formatNumber(totals.medika);
            document.getElementById('sumFarmed').innerText = formatNumber(totals.farma + totals.medika);
            document.getElementById('sumCN').innerText = formatNumber(valCN);
            document.getElementById('grandTotalHna').innerText = formatNumber(totals.grandHna);
            document.getElementById('totalPpn').innerText = formatNumber(totalPpnVal);
            document.getElementById('totalNet').innerText = formatNumber(totalNetVal);
            
            if (tableHtml !== "") {
                document.getElementById('resultsArea').style.display = 'block';
                if (isManual) saveHistory();
            }
        }

        function saveHistory() {
            let history = [];
            document.querySelectorAll('.product-row-modern').forEach(row => {
                history.push({ v: row.querySelector('.prod-input').value, q: row.querySelector('.qty-input').value });
            });
            localStorage.setItem('lapi_hist_v2', JSON.stringify(history));
            localStorage.setItem('lapi_cust', document.getElementById('customerName').value);
            localStorage.setItem('lapi_dist', document.getElementById('distributorSelect').value);
            localStorage.setItem('lapi_disc', document.getElementById('discountInput').value);
        }

        function loadHistory() {
            document.getElementById('customerName').value = localStorage.getItem('lapi_cust') || "";
            document.getElementById('distributorSelect').value = localStorage.getItem('lapi_dist') || "MPI";
            document.getElementById('discountInput').value = localStorage.getItem('lapi_disc') || "0";
            const saved = localStorage.getItem('lapi_hist_v2');
            if (saved) { 
                JSON.parse(saved).forEach(item => addProductRow(item.v, item.q)); 
                calculate(false); 
            } else { 
                addProductRow(); 
            }
        }

        function preparePrint() { window.print(); }
        function resetAll() { if (confirm("Hapus semua data?")) { localStorage.clear(); location.reload(); } }

        window.onload = loadData;
    </script>
</body>
</html>
