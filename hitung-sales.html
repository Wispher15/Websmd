<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hitung Sales - Web SMD 2026</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        /* CSS KHUSUS PRINT */
        @media print {
            @page { 
                size: portrait;
                margin: 0.8cm; 
            }
            body { background: white; font-family: Arial, sans-serif; font-size: 10pt; }
            
            /* Sembunyikan elemen navigasi dan INPUT */
            .sidebar, header, .customer-section-modern, 
            .btn-add-modern, .calc-settings, .btn-go, 
            .action-buttons-modern, h3,
            #productsContainer, /* Menghilangkan seluruh area input produk saat print */
            .modern-table th:first-child, .modern-table td:first-child,
            #typeSummary { 
                display: none !important; 
            }

            .main-content { margin: 0 !important; padding: 0 !important; width: 100%; }
            .card { border: none !important; box-shadow: none !important; padding: 0 !important; margin-bottom: 0 !important; }
            .content-area { padding: 0 !important; }

            /* Header Surat Pesanan */
            #printHeader { 
                display: block !important; 
                border-bottom: 2px solid #000; 
                margin-bottom: 20px; 
                padding-bottom: 10px;
            }

            /* Tabel PDF */
            .modern-table { width: 100%; border-collapse: collapse !important; margin-top: 10px; }
            .modern-table th, .modern-table td { 
                border: 1px solid #000 !important; 
                padding: 8px !important; 
                text-align: center;
                color: #000 !important;
            }
            .modern-table td:nth-child(2) { text-align: left; }

            /* Area Total */
            .summary-grid-modern { 
                display: flex !important; 
                justify-content: flex-end !important; 
                margin-top: 15px;
                background: none !important;
                border: none !important;
            }
            .grand-total-modern { width: 250px; text-align: right; }
            .grand-total-modern div { padding: 4px 0; border-bottom: 1px solid #eee; }
            .net-label { font-size: 14pt !important; font-weight: bold; border-top: 2px solid #000 !important; color: #000 !important; }

            #printSignature { display: block !important; margin-top: 50px; text-align: right; }
        }
        
        #printHeader, #printSignature { display: none; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">ONLINE SYSTEM</div>
        <ul class="menu-list">
            <li><a href="index.html" class="menu-item">Dashboard</a></li>
            <li><a href="stok-distributor.html" class="menu-item">Stok Distributor</a></li>
            <li><a href="hitung-sales.html" class="menu-item active">Hitung Sales</a></li>
        </ul>
    </div>

    <div class="main-content">
        <div id="printHeader">
            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <div>
                    <h2 style="margin:0;">SURAT PESANAN (SP)</h2>
                    <p style="margin:4px 0;"><strong>Customer:</strong> <span id="displayCustomerName">-</span></p>
                    <p style="margin:0;"><strong>Distributor:</strong> <span id="displayDistributor">-</span></p>
                </div>
                <div style="text-align: right;">
                    <p style="margin:0;"><strong>No:</strong> <span id="displayNota">-</span></p>
                    <p style="margin:4px 0;"><strong>Tanggal:</strong> <span id="displayDate">-</span></p>
                </div>
            </div>
        </div>

        <header><span>Kalkulator Lapi - Sales Pro</span></header>
        
        <div class="content-area">
            <div class="card" style="margin-bottom: 20px;">
                <div class="customer-section-modern">
                    <div class="input-group">
                        <label>Nama Customer</label>
                        <input type="text" id="customerName" class="url-bar" placeholder="Nama Apotek/Klinik...">
                    </div>
                    <div class="input-group">
                        <label>Distributor</label>
                        <select id="distributorSelect" class="url-bar">
                            <option value="MPI">MPI</option>
                            <option value="Kalista">Kalista</option>
                            <option value="Penta Valent">Penta Valent</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px; font-size: 1rem;">Daftar Input Produk</h3>
                <div id="productsContainer"></div>
                <button class="btn-add-modern" onclick="addProductRow()">+ Tambah Produk</button>
                <div class="calc-settings">
                    <div class="input-group">
                        <label>Jenis Harga</label>
                        <select id="hargaType" class="url-bar">
                            <option value="hna">HNA (Box)</option>
                            <option value="harga_tab">Eceran (Tab/Syp)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Diskon (%)</label>
                        <input type="number" id="discountInput" class="url-bar" value="0">
                    </div>
                </div>
                <button class="btn-go" style="width: 100%; margin-top: 15px;" onclick="calculate(true)">Proses Hitung</button>
            </div>

            <div id="resultsArea" style="display:none;">
                <div class="card">
                    <table class="modern-table border-vertical">
                        <thead>
                            <tr>
                                <th>Type-Div</th>
                                <th>Nama Produk</th>
                                <th>Qty</th>
                                <th>Harga</th>
                                <th>Total HNA</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>

                    <div class="summary-grid-modern">
                        <div id="typeSummary">
                            <div class="sum-line">Oral: <span id="sumOral">0</span></div>
                            <div class="sum-line">Injeksi: <span id="sumInjeksi">0</span></div> <div class="sum-line highlight">BRANDED (O+I): <span id="sumBranded">0</span></div>
                            <div class="sum-line">Generik: <span id="sumGenerik">0</span></div>
                            <div class="sum-line">Farma Pure: <span id="sumFarmaPure">0</span></div>
                            <div class="sum-line">Medika: <span id="sumMedika">0</span></div>
                            <div class="sum-line" style="border-top:1px solid #ddd; margin-top:5px; padding-top:5px;">Farmed: <span id="sumFarmed">0</span></div>
                            <div class="sum-line" style="background:#fff3cd; padding:4px; border-radius:4px; margin-top:5px;">CN (Disc): <span id="sumCN">0</span></div>
                        </div>

                        <div class="grand-total-modern">
                            <div>TOTAL HNA: <span id="grandTotalHna">0</span></div>
                            <div>+PPN 11%: <span id="totalPpn">0</span></div>
                            <div class="net-label">TOTAL NET: <span id="totalNet">0</span></div>
                        </div>
                    </div>

                    <div id="printSignature">
                        <p style="margin-bottom: 60px;">Hormat Kami,</p>
                        <p><strong>( __________________________ )</strong></p>
                    </div>

                    <div class="action-buttons-modern">
                        <button class="btn-go" style="background: #3b82f6; flex: 1;" onclick="preparePrint()">Simpan PDF</button>
                        <button class="btn-go" style="background: #64748b; flex: 1;" onclick="resetAll()">Reset</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <datalist id="productList"></datalist>

    <script>
        let productDatabase = [];

        function cleanNumber(str) { return str ? parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0 : 0; }
        function formatNumber(num) { return Math.round(num).toLocaleString('id-ID'); }

        function loadData() {
            fetch("https://raw.githubusercontent.com/Wispher15/Websmd/refs/heads/main/Harganov25.csv")
            .then(res => res.text()).then(data => {
                const lines = data.split("\n").slice(1);
                let options = "";
                lines.forEach(line => {
                    const cols = line.split(",");
                    if (cols.length >= 7) {
                        productDatabase.push({
                            kode: cols[0].trim(), nama: cols[1].trim(), hna: cleanNumber(cols[2]),
                            divisi: cols[5].trim().toUpperCase(), type: cols[6].trim().toUpperCase(), harga_tab: cleanNumber(cols[4])
                        });
                        options += `<option value="${cols[1].trim()} (${cols[0].trim()})">`;
                    }
                });
                document.getElementById('productList').innerHTML = options;
                loadHistory();
            });
        }

        function addProductRow(v = "", q = 1) {
            const id = Date.now() + Math.random();
            document.getElementById('productsContainer').insertAdjacentHTML('beforeend', `
                <div class="product-row-modern" id="row-${id}">
                    <input type="text" list="productList" class="url-bar prod-input" value="${v}" placeholder="Cari Produk...">
                    <input type="number" class="url-bar qty-input" value="${q}" style="width:70px; text-align:center;">
                    <button class="btn-del-mini" onclick="document.getElementById('row-${id}').remove()">âœ•</button>
                </div>`);
        }

        function calculate(isManual) {
            let totals = { oral: 0, inj: 0, gen: 0, fp: 0, med: 0, g: 0 };
            const hType = document.getElementById('hargaType').value;
            const disc = parseFloat(document.getElementById('discountInput').value) || 0;
            let tableHtml = '';

            document.querySelectorAll('.product-row-modern').forEach(row => {
                const val = row.querySelector('.prod-input').value;
                const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
                const p = productDatabase.find(i => `${i.nama} (${i.kode})` === val || i.nama === val);

                if (p && qty > 0) {
                    const price = (hType === 'hna') ? p.hna : p.harga_tab;
                    const sub = price * qty;
                    tableHtml += `<tr><td>${p.type}-${p.divisi}</td><td>${p.nama}</td><td>${qty}</td><td>${formatNumber(price)}</td><td>${formatNumber(sub)}</td></tr>`;
                    
                    if (p.type.includes('ORAL')) totals.oral += sub;
                    if (p.type.includes('INJEKSI')) totals.inj += sub;
                    if (p.type.includes('GENERIK')) totals.gen += sub;
                    if (p.divisi === 'FARMA') { if (!p.type.includes('GENERIK')) totals.fp += sub; }
                    if (p.divisi === 'MEDIKA') totals.med += sub;
                    totals.g += sub;
                }
            });

            document.getElementById('tableBody').innerHTML = tableHtml;
            document.getElementById('sumOral').innerText = formatNumber(totals.oral);
            document.getElementById('sumInjeksi').innerText = formatNumber(totals.inj); // Update Nilai Injeksi
            document.getElementById('sumBranded').innerText = formatNumber(totals.oral + totals.inj);
            document.getElementById('sumGenerik').innerText = formatNumber(totals.gen);
            document.getElementById('sumFarmaPure').innerText = formatNumber(totals.fp);
            document.getElementById('sumMedika').innerText = formatNumber(totals.med);
            document.getElementById('sumFarmed').innerText = formatNumber(totals.fp + totals.med + totals.gen);
            document.getElementById('sumCN').innerText = formatNumber(totals.g * (disc/100));
            document.getElementById('grandTotalHna').innerText = formatNumber(totals.g);
            document.getElementById('totalPpn').innerText = formatNumber(totals.g * 1.11);
            document.getElementById('totalNet').innerText = formatNumber((totals.g * 1.11) * (1 - (disc/100)));
            
            if (tableHtml) { document.getElementById('resultsArea').style.display = 'block'; if (isManual) saveHistory(); }
        }

        function saveHistory() {
            let hist = [];
            document.querySelectorAll('.product-row-modern').forEach(row => {
                hist.push({ v: row.querySelector('.prod-input').value, q: row.querySelector('.qty-input').value });
            });
            localStorage.setItem('lapi_hist_v2', JSON.stringify(hist));
            localStorage.setItem('lapi_cust', document.getElementById('customerName').value);
            localStorage.setItem('lapi_dist', document.getElementById('distributorSelect').value);
        }

        function loadHistory() {
            document.getElementById('customerName').value = localStorage.getItem('lapi_cust') || "";
            document.getElementById('distributorSelect').value = localStorage.getItem('lapi_dist') || "MPI";
            const saved = localStorage.getItem('lapi_hist_v2');
            if (saved) { JSON.parse(saved).forEach(item => addProductRow(item.v, item.q)); calculate(false); } 
            else { addProductRow(); }
        }

        function preparePrint() {
            document.getElementById('displayCustomerName').innerText = document.getElementById('customerName').value || "UMUM";
            document.getElementById('displayDistributor').innerText = document.getElementById('distributorSelect').value;
            const now = new Date();
            document.getElementById('displayNota').innerText = "SP-" + now.getTime().toString().slice(-6);
            document.getElementById('displayDate').innerText = now.toLocaleDateString('id-ID');
            window.print();
        }

        function resetAll() { if (confirm("Hapus semua data?")) { localStorage.clear(); location.reload(); } }
        window.onload = loadData;
    </script>
</body>
</html>
